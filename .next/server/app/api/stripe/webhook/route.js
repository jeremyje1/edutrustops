"use strict";(()=>{var e={};e.id=757,e.ids=[757],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},73837:e=>{e.exports=require("util")},94679:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>w,originalPathname:()=>T,patchFetch:()=>b,requestAsyncStorage:()=>h,routeModule:()=>I,serverHooks:()=>v,staticGenerationAsyncStorage:()=>R,staticGenerationBailout:()=>f});var o={};r.r(o),r.d(o,{POST:()=>m});var a=r(10884),s=r(16132),i=r(21040),n=r(95798),c=r(69419),u=r.n(c),p=r(7542);async function l(e){let t=e.customer,r=e.subscription,o=e.metadata||{},a=o.institution_name||"New Institution";await p.Z.tenant.create({data:{name:a,stripeCustomerId:t,stripeSubscriptionId:r||void 0,tier:e.metadata?.tier||void 0}}),console.log("Tenant created from checkout:",a)}async function d(e,t){let r=[process.env.NEXT_PUBLIC_STRIPE_PRICE_CORE,process.env.NEXT_PUBLIC_STRIPE_PRICE_CORE_MONTHLY].filter(Boolean),o=[process.env.NEXT_PUBLIC_STRIPE_PRICE_PRO,process.env.NEXT_PUBLIC_STRIPE_PRICE_PRO_MONTHLY].filter(Boolean),a=[process.env.NEXT_PUBLIC_STRIPE_PRICE_ENTERPRISE,process.env.NEXT_PUBLIC_STRIPE_PRICE_ENTERPRISE_MONTHLY].filter(Boolean),s=e=>e.includes(t),i=null;if(s(r)?i="core":s(o)?i="pro":s(a)&&(i="enterprise"),!i){console.warn(`Unknown priceId ${t} â€“ leaving tier unchanged`);return}await p.Z.tenant.updateMany({where:{stripeCustomerId:e},data:{tier:i}}),console.log(`Updated tenant ${e} to tier ${i}`)}async function E(e){let t=e.customer;await p.Z.tenant.updateMany({where:{stripeCustomerId:t},data:{stripeSubscriptionId:null}}),console.log(`Subscription canceled for customer ${t}`)}async function _(e){let t=e.customer;console.warn(`Payment failed for customer ${t} (invoice ${e.id})`)}let P=new(u())(process.env.STRIPE_SECRET_KEY||"",{apiVersion:"2022-11-15"});async function m(e){let t;let r=e.headers.get("stripe-signature"),o=await e.arrayBuffer();try{t=P.webhooks.constructEvent(Buffer.from(o),r||"",process.env.STRIPE_WEBHOOK_SECRET||"")}catch(e){return console.error("Webhook signature verification failed",e.message),new n.Z("Webhook Error: Invalid signature",{status:400})}switch(console.log(`[stripe] ${t.type}`),t.type){case"checkout.session.completed":{let e=t.data.object;await l(e);break}case"customer.subscription.updated":{let e=t.data.object;await d(e.customer,e.items.data[0].price.id);break}case"customer.subscription.deleted":{let e=t.data.object;await E(e);break}case"invoice.payment_failed":{let e=t.data.object;await _(e)}}return n.Z.json({received:!0})}let I=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:"app/api/stripe/webhook/route"},resolvedPagePath:"/Users/jeremy.estrella/Desktop/edutrustops/src/app/api/stripe/webhook/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:h,staticGenerationAsyncStorage:R,serverHooks:v,headerHooks:w,staticGenerationBailout:f}=I,T="/api/stripe/webhook/route";function b(){return(0,i.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:R})}},7542:(e,t,r)=>{let o;r.d(t,{Z:()=>s});let a=require("@prisma/client");o=new a.PrismaClient;let s=o}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[271,107,419],()=>r(94679));module.exports=o})();